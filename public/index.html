<!DOCTYPE HTML>
<html>
<head>
<script type="text/javascript">
var ws = new Object;

function open() {
    if (!("WebSocket" in window)) {
        alert("WebSocket NOT supported by your Browser!");
        return;
    }
    console.log('open');
    ws = new WebSocket("ws://"+window.location.host+"/api/ws");
    ws.onopen = function() {
        console.log('connected');
        ws.send('{"sub":"block"}');
        ws.send('{"sub":"tx"}');
        /*
        ws.send('{"sub":"addr","addr":"1ELxerXdNR1VkwqJ9Nzs2B9pxR4eVtAXY2","get":"bal,tx"}');
        ws.send('{"sub":"addr","addr":"13hFFWeBsJYuAYU8wTLPo6LL1wvGrTHPYC","get":"tx"}');
        ws.send('{"sub":"addr","addr":"1Cfox99B3P4w3pb8Ng54qah6HRFne65aMu","get":"bal"}');
        */
    };
    ws.onmessage = function (evt)
    {
        var res = JSON.parse(evt.data);
        console.log("Received: ", res);
        var txt;
        if(res.block){
            txt = document.createElement('div');
            txt.innerHTML='<span class="blkid">'+res.block.hash+'</span>'+
                '<span class="height">'+res.block.header.height+'</span>'+
                '<span class="parent">'+res.block.header.parent+'</span>'+
                '<span class="sigs">Sigs '+res.block.sign.length+' </span>';
            if(Object.keys(res.block.txs).length>0){
                txt.innerHTML+=(Object.keys(res.block.txs).reduce(
                        function(Acc,E){
                            return Acc+'<div class="txl">'+'<span class="txaddr">'+res.block.txs[E].from+
                                ' -&gt; '+res.block.txs[E].to+
                                '</span><span class="amount">'+res.block.txs[E].amount+' '
                                +res.block.txs[E].cur+'</span>'+'</div>';

                        },""
                    ));
            }
        }else if(res.balance){
            txt = document.createElement('div');
            txt.innerHTML='<span class="address">'+res.address+'</span>'+
                '<span class="bal">'+JSON.stringify(res.balance)+'</span>';
        }else if(res.txs){
            txt = document.createElement('div');
            txt.innerHTML='<span class="address">'+res.address+'</span>'+
                '<span class="txs">'+
                Object.values(res.txs).reduce(
                    function(Acc,E){
                        return Acc+'<span class="txaddr">'+E.from+' -&gt; '+E.to+'</span><span class="amount">'+E.amount+' '+E.cur+'</span>';
                    },
                    "") +'</span>';
        }else{
            txt = document.createElement('pre');
            txt.innerHTML=evt.data+"\n";
        }
        document.getElementById('messages').prepend(txt);
    };
    ws.onclose = function()
    {
        // websocket is closed.
        console.log('close');
        open();
    };
    function doPing() {
        console.log("Ping");
        if (ws != "undefined") {
            ws.send("ping");
        }
    }
    var ping = setInterval(function () { doPing() }, 60000);
};
open();
</script>
</head>
<body>
    <a href="/demo/index.html">Demo wallet</a>
<style>
div {
    border-bottom: 1px solid black;
    font-family: courier;
}
.height {
    font-size: 1em;
}

.txs {
    font-size: 1em;
}

.address {
    font-size: 0.8em;
    color: green;
}

.bal {
    font-size: 0.8em;
}

.parent {
    font-size: 0.5em;
    color: blue;
}

.amount {
    margin: 0 5px;
}

.blkid {
    font-size: 0.8em;
    color: red;
}

</style>
<div id="messages">
</div>
</body>
</html>
