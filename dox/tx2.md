# The power transaction format version 2

## Transaction structure

Transaction is a message pack map (named transaction container) with such 
structure:

```

{
  "body": BinaryBody,
  "sig": Array,
  "ver": 2
}

```

keys should be encoded as a strings.

Field "body" contains binary (0xc4 msgpack type) with msgpack encoded 
transaction payload (named transaction body), which also used for signing.
Unpacked body must be map and should have at least key "k" (string)
which indicates transaction kind (integer).
For best extendability transaction kind number unique for each kind with each
transaction version. Headers with constans should be generated by scripts 
of supplied JSON file (priv/tx_const.json in tpnode repo):

```

{
  "purpose": {
    "0": "transfer",
    "1": "srcfee",
    "2": "dstfee",
    "3": "gas"
  },
  "kind": {
    "16": ["generic", 2],
    "17": ["register", 2],
    "18": ["deploy", 2],
    "19": ["patch", 2],
    "20": ["block", 2]
  }
}

```

Field "sig" contains msgpack's list (types 0x90-0x9f or 0xdc-0xdc). 
Each array item contains signature for one key. Signature format
described below.
Transaction might have multiple signatures.

Field "ver" must me an integer, which indicates version of transaction to
specifiy which body decoder should be used. As for now it must be 2 (0x02 in
mshpack).


## Generic transactions (money transfer and/or call smartcontract)

Money transfer and smartcontract calling transactions must contains following
fields

 - "f" (from) - source address, must be 8 byte binary (0xc4 msgpack type),
 - "to" (to) - destination address, must be 8 byte binary as well,
 - "s" (seq) - tx nonce, must be positive integer (0x00 - 0x7f or 0xcc - 0xcf)
 - "t" (timestamp) - tx unitime in milliseconds, positive integer exactly as seq,
 - "p" (payload) - array of amounts (see below)

Also there is optional attributes

- "c" (call) - for transaction intended to call smartcontract method. This
  attribute should contrains 2 element array (0x92), first element method name
 (string), second - array of arguments (arbitrary types, but tx call with 
 incorrect types will be dropped by smartcontract). 
 - "e" (extradata) - map with arbitrary extra data which might be used by
 smartcontract or wallet application. Key "code" reserverd for "deploy"
 method and should not be used for any other purposes (types 0x80 - 0x8f or
0xde - 0xdf). For readable text message key "msg" should be used. 

Attribute "p" (payload) must contrains arbitrary number of 3 element arrays
(0x93).
First element should contrain purpose (integer) from JSON shown before.
Second element should contain currency identified (binary) Using string type
as currecy identifier also permitted, but only if currency identifier contains
just ASCII characters with codes 32-126).
Third element should contain amount (integer). This field MUST be only
integer and MUST NOT be float or any other types.
If array contains more than 3 elements, extra elements shoud be ignored (it
might be array generated by software with newer version of protocol).
Clients MUST NOT add extra fields to array when creating transaction, because
it might break compatibility with new versions.

here is an example of whole transaction (190 bytes) encoded in base64

```
g6Rib2R5xD+HoWWAoWbECIAAIAACAAADoWsQoXCSkwCjWFhYCpMBo0ZFRRShcwWhdM8AAAFkQXBXF6J0b8QIgAAgAAIAAAWkc2lnboHEIQPoKI4bYEc4uTuycqS/ipQHaHjEx3SZTp/hqIIVLE9L88RHMEUCIQD4jWcnksiFrUIZvCv4sjD9ustDe62c5PpQwuNA71Ys7QIgKhKkBd2LPsn6ryJs+FA+ZSOebqaXlokbJGofDVSPYQSjdmVyAg==
```


unpacking of this tx will give (all binaried encoded in base64)

```
{
  "body" => h6FlgKFmxAiAACAAAgAAA6FrEKFwkpMAo1hYWAqTAaNGRUUUoXMFoXTPAAABZEFwVxeidG/ECIAAIAACAAAF
    "sig" => {
      A+gojhtyygRzi5O7JypL+KlAdoeMTHdJlOn+GoghUsT0vz =>
        MEUCIQD4jWcnksiFrUIZvCv4sjD9ustDe62c5PpQwuNA71Ys7QIgKhKkBd2LPsn6ryJs+FA+ZSOebqaXlokbJGofDVSPYQQ=
    },
    "ver" => 2
}
```


After unpacking body (63 bytes) will be (binaries shown as hex)

```
{
  "k" => 16,
  "f" => 0x8000200002000003,
  "to" => 0x8000200002000005,
  "s" => 5,
  "t" => 1530106238743,
  "p" => [
    [0,"XXX",10],
    [1,"FEE",20]
  ],
  "e" => #{}
}
```

this transaction transfers 10 tokens named XXX from address 0x8000200002000003 
to 0x8000200002000005 and pays 20 tokens named FEE for this transaction.
Kind - 16 (generic version 2)
Tx nonce - 5, timestamp - 1530106238743 (2018-06-27 13:30:38.743 UTC).
And there is no extra data.

Private key used for signing this transaction is (encoded in base64)
LwNyxasiTb1vNcbRf51iltMDGQvijI515PVrpphmZSA=
YOU MUST NOT USE THIS PRIVATE KEY ANYWHERE, or you money will be stolen.


## Registration of wallet

For registration of new wallet there is "register" transaction type.
Binaried shown as base64,

```
{
  "k"=> 17,
  "t"=> 1530106891372
  "inv" => ft3wvE2hqJo5qN+WbwP6lSgV4ZnZvK12HMO6whebb7E=,
  "nonce" => T1umkWY=,
  "h" => Y6dVG5CvZacwlbf21oybiIHh/4h+8d2EJwF7Qp/GpCA=
}
```

Field "k" is transaction kind,

Field "t" is timestamp (unixtime in milliseconds).

Field "inv" is optional. If invite code is used, field "inv" should contain sha256 of invite code.  Plain invite code should be placed in *container* to "inv" field. That plain text invite code will be removed right before putting to block to avoid code disclosure.

Field "nonce" can be any type, it will not be for anything. It used only to 
adjust body's hash.

Field "h" should contain sha256 hash of concatenated public keys sorted
ascending.

Example:

Let's take 3 arbitrary public keys:

```
[<<"025348F9AD2BDC8E394B7C3C69FDD221F8C7F95B458D56AACD677C4C9ABF8E1AE7">>,
 <<"0234326DF0BDF60DA3E6D203B73C0D0C4DEE518BD60717C3B20C0D27812C7DADEB">>,
 <<"02266C9DAA52F9BB5AD73B77A703437E27A3344F36F1D4FF0C0267C3DEA2BC91D7">>
]
```

After sorting we will get:

```
[<<"02266C9DAA52F9BB5AD73B77A703437E27A3344F36F1D4FF0C0267C3DEA2BC91D7">>,
 <<"0234326DF0BDF60DA3E6D203B73C0D0C4DEE518BD60717C3B20C0D27812C7DADEB">>,
 <<"025348F9AD2BDC8E394B7C3C69FDD221F8C7F95B458D56AACD677C4C9ABF8E1AE7">>
]
```

Should be concatenated: `0x02266C9DAA52F9BB5AD73B77A703437E27A3344F36F1D4FF0C0267C3DEA2BC91D70234326DF0BDF60DA3E6D203B73C0D0C4DEE518BD60717C3B20C0D27812C7DADEB025348F9AD2BDC8E394B7C3C69FDD221F8C7F95B458D56AACD677C4C9ABF8E1AE7` and their sha256 will be: `0xCB32960606B0E3846D763B8DA8FE5EF7379D89A227C2B6DBDA499F4ECEA0B071`, this value (in binary) shoud be in "h" field.


## Deploy contract



## Patch transactions



## Block passing transactions



## Signature format

Each signature may contain additional data, which is signed with main payload
(body). Additional data may contain few predefined fields and arbitrary fields
as well, this fields pack in TLV format.

Here is predefined fields

| name           | length | tag | type   |
|----------------|--------|-----|--------|
| timestamp      | 8      | 1   | uint64 |
| pubkey         | vary   | 2   | binary |
| createduration | 8      | 3   | uint64 |
| OTHER          | vary   | 240 | binary |
| purpose        | vary   | 254 | string |
| signature      | vary   | 255 | binary |

To sign some payload you should pack additional data (at least pubkey).
Let's imagine we have private key 
`0x0102030405060708090001020304050607080900010203040506070809000102`
and we need sign string "Hello, world!". 

First of all we need to calculate public key, for this private key it will be
`0x02B1912FABA80FCECD2A64C574FEFE422C61106001EC588AF1BD9D7548B81064CB`
Let's additionaly put timestamp 1532000000000 into signature.

Our whole binary will be such:

```
02 21 02B1912FABA80FCECD2A64C574FEFE422C61106001EC588AF1BD9D7548B81064CB 
01 08 00000164B250D800
```

Now we have to append payload for calculating signature

```
02 21 02B1912FABA80FCECD2A64C574FEFE422C61106001EC588AF1BD9D7548B81064CB 
01 08 00000164B250D800 48656C6C6F2C20776F726C6421
```

sha256 of this whole binary will be 
`60C3B88A5F32816F574C8FABFB45A35338A20D7C1678F20DABDBBD7F94568F15` 
and signature will be

```
304402205250D827749F285CE174137EC88B394092E43B9E6C6774045EE5E6ED5023225202204D1628F019E57BF19C1A0FE37193355A059F22CF8203D85E112FF3B4873D46FE
```

Now packed extradata should be prepended by signature with tag 255 and correct length

```
FF 46 304402205250D827749F285CE174137EC88B394092E43B9E6C6774045EE5E6ED5023225202204D1628F019E57BF19C1A0FE37193355A059F22CF8203D85E112FF3B4873D46FE
02 21 02B1912FABA80FCECD2A64C574FEFE422C61106001EC588AF1BD9D7548B81064CB 
01 08 00000164B250D800
```

